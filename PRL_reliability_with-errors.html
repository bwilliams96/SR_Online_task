<!DOCTYPE html>
<html>

<head>
  <title>My experiment</title>
  <script src="jspsych-6.1.0/jspsych.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-2image-keyboard-response.js"></script>
  <script src="extra_js/functions.js"></script>
  <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>

<body></body>
<script>
  //***** Setup task *****//
  var n_trials = 150; //Number of trials
  var prob_cor = 0.8; //Probability of win on 'correct' choice
  var prob_incor = 0.2; //Probability of win on 'incorrect' choice
  var max_consec = 5; //Number of trials over which assigned probabilitites are true
  var win_value_cor = 1; //Value of win on 'correct' option
  var loss_value_cor = -1; //Value of loss on 'correct' option
  var win_value_incor = 1; //Value of win on 'incorrect' option
  var loss_value_incor = -1; //Value of loss on 'incorrect' option
  var rev_interval = 15; //Interval between reversals
  var rev_diff = 3; //Range around which reversals can occur
  var rev_num = 9; //Number of reversals
  var cor_oc = makeArray(prob_cor, n_trials, max_consec, win_value_cor, loss_value_cor) //'Correct' choice outcomes
  var incor_oc = makeArray(prob_incor, n_trials, max_consec, win_value_incor, loss_value_incor) //'Incorrect' choice outcomes
  var reversal_point = setReversal(rev_interval, rev_diff, rev_num)
  // initilisation
  var stimuli = [];
  for (var i = 0; i < n_trials; i++) {
    stimuli.push(imageShuffle())
  }
  var correctCount = 0;
  var incorrectCount = 0;
  var score = 0;
  var event_trial_count = 0;
  var cor_choice = jsPsych.randomization.sampleWithoutReplacement([1, 2], 1); // select initial correct stimulus
  var trial_count = 0;
  // learning criterion
  //var criterionDenominator = 2;
  //var crit = 1;
  //var n_trials_at_crit = 0;
  var criterion = false;
  var cumulative = 0;
  // timings
  var stim_dur = 200;
  var oc_dur = 200;
  var cum_dur = 200;

  //***** Define on screen windows *****//

  // Task instructions
  var instructions = {
    type: "html-keyboard-response",
    stimulus: "<p> Insert instructions here </p>"
  };

  // Display stimuli
  var stimuli_display = {
    type: '2image-keyboard-response',
    stimulusLeft: function() {
      return "img/" + stimuli[trial_count].left
    },
    stimulusRight: function() {
      return "img/" + stimuli[trial_count].right
    },
    choices: ['leftArrow', 'rightArrow'],
    trial_duration: stim_dur,
    data: {
      trial_phase: "choice",
      stimulusLeft: function() {
        return stimuli[trial_count].left
      },
      stimulusRight: function() {
        return stimuli[trial_count].right
      }
    },
    on_finish: function(data) {
      if (data.key_press == 39) {
        data.resp = "right"
      } else if (data.key_press == 37) {
        data.resp = "left"
      } else {
        data.resp = null
      }
      if (data.resp != null) {
        data.choice =  [trial_count][data.resp]
      } else {
        data.choice = null
      }
      data.cor = data.choice == "fractal" + cor_choice + ".jpg"
      data.cor_im = "fractal" + cor_choice + ".jpg"
    }
  };

  // Highlight chosen !!! How should we fix the styling of this?
  var response_display = {
    type: '2image-keyboard-response',
    stimulusLeft: function() {
      if (jsPsych.data.get().last(1).values()[0].resp != null) {
      return "img/" + stimuli[trial_count].left
    } else {
      return
      }
    },
    stimulusRight: function() {
      if (jsPsych.data.get().last(1).values()[0].resp != null) {
      return "img/" + stimuli[trial_count].right
      } else {
        return
      }
    },
    choices: [jsPsych.NO_KEYS],
    highlight: function() {
      return jsPsych.data.get().last(1).values()[0].resp
    },
    prompt: function() {
      if (jsPsych.data.get().last(1).values()[0].resp == null) {
        return "Too slow! No image selected."
      } else {
        return null
      }
    },
    trial_duration: stim_dur,
    data: {
      trial_phase: "resp_fb"
    }
  };

  // Display outcome
  var outcome_display = {
    type: 'html-keyboard-response',
    prompt: 'Points change',
    stimulus: function() {
      var data = jsPsych.data.get().filter({
        trial_phase: "choice"
      }).last(1).values()[0]
      if (data.cor) {
        var oc = cor_oc[correctCount]
      } else {
        if (data.resp == null) {
          var oc = -1
          }
          else {
          var oc = incor_oc[incorrectCount]
        }
      }

      return oc
    },
    choices: [jsPsych.NO_KEYS],
    trial_duration: oc_dur,
    data: {
      trial_phase: "oc_fb"
    }
  };

  // Display total
  var cumulative_display = {
    type: 'html-keyboard-response',
    prompt: 'Cumulative total',
    stimulus: function() {
      var data = jsPsych.data.get().filter({
        trial_phase: "choice"
      }).last(1).values()[0]
      if (data.cor) {
        cumulative = cumulative +cor_oc[correctCount]
        correctCount++
      } else {
        if (data.resp == null) {
          cumulative = cumulative -1
          } else {
          cumulative = cumulative + incor_oc[incorrectCount]
          incorrectCount++
        }
      }
      return cumulative
    },
    choices: [jsPsych.NO_KEYS],
    trial_duration: cum_dur,
    data: {
      trial_phase: "cum_fb"
    },
    on_finish: function(data) {
      trial_count++
      event_trial_count++
    }
  };

  //***** Define task loop *****//

  var prl = [stimuli_display, response_display, outcome_display, cumulative_display]
  var main = {
    timeline: prl,
    loop_function: function() {
      if (trial_count < n_trials) {
        if (reversal_point.includes(trial_count)) {
          cor_choice = (cor_choice * -1) + 3;
        }
        return true
      } else {
        return false
      } 
    }
  }

  /* start the experiment */
  jsPsych.init({
    timeline: [instructions, main],
    on_finish: function() {
      jsPsych.data.displayData();
    }
  });
</script>

</html>
