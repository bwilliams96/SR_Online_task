<!DOCTYPE html>
<html>

<head>
  <title>My experiment</title>
  <script src="jspsych-6.1.0/jspsych.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-2image-keyboard-response.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
  <script src="extra_js/functions.js"></script>
  <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>

<body></body>
<script>
  //***** Setup task *****//
  // Set task parameters
  var n_trials = 150; //Number of trials
  var prob_cor = 0.8; //Probability of win on 'correct' choice
  var prob_incor = 0.2; //Probability of win on 'incorrect' choice
  var max_consec = 5; //Number of trials over which assigned probabilitites are true
  var win_value_cor = 1; //Value of win on 'correct' option
  var loss_value_cor = -1; //Value of loss on 'correct' option
  var win_value_incor = 1; //Value of win on 'incorrect' option
  var loss_value_incor = -1; //Value of loss on 'incorrect' option
  var rev_interval = 15; //Interval between reversals
  var rev_diff = 3; //Range around which reversals can occur
  var rev_num = 9; //Number of reversals
  var cm_thresh = 5; // number of consecutive trials where participant can miss response before being kicked, note this value is inclusive
  var total_thresh = 0.05; //proportion of total trials that can be missed before being kicked, note this number will be rounded up and inclusive
  var cor_oc = makeArray(prob_cor, n_trials, max_consec, win_value_cor, loss_value_cor) //'Correct' choice outcomes
  var incor_oc = makeArray(prob_incor, n_trials, max_consec, win_value_incor, loss_value_incor) //'Incorrect' choice outcomes
  var reversal_point = setReversal(rev_interval, rev_diff, rev_num)

  // initilisation of variables
  var stimuli = [];
  for (var i = 0; i < n_trials; i++) {
    stimuli.push(imageShuffle())
  }
  var correctCount = 0;
  var incorrectCount = 0;
  var score = 0;
  var event_trial_count = 0;
  var cor_choice = jsPsych.randomization.sampleWithoutReplacement([1, 2], 1); // select initial correct stimulus
  var trial_count = 0;
  var consec_miss = 0;
  var total_miss = 0;
  var cumulative = 0;

  // timings
  var max_rt = 2000; //maximum wait time for a keypress (ms)
  var stim_dur = 1000; //time image is highlighted for (ms)
  var oc_dur = 1000; //time outcome is shown for (ms)
  var cum_dur = 1000; //time total is shown for (ms)

  //***** Define on screen windows *****//

  // Task instructions
  var instructions = {
    type: "html-keyboard-response",
    stimulus: "<p>In this experiment, you will see abstract images " +
            "appear on the screen.</p><p>You must " +
            "choose only <strong>1</strong> of the 2 images displayed on the screen during each " +
            "trial.</p><p>You will earn points based on your choices.</p><p>Your goal is to " +
            "accumulate as many points as possible by the end of the trials.</p><p>If you " +
            "choose the image on the <strong>left</strong> side of the screen, press the <strong>'Left Arrow'</strong> " +
            "key on the keyboard.</p><p>If you choose the image on the <strong>right</strong> side of the " +
            "screen, press the <strong>'Right Arrow'</strong> key on the keyboard.</p>" +
            "<p>Please respond as quickly as possible, you will have limited time per trial.</p>" +
            "<p>Press any key to begin 10 practice trials.</p>",
        };
  // Display stimuli
  var stimuli_display = {
    type: '2image-keyboard-response',
    stimulusLeft: function() {
      return "img/" + stimuli[trial_count].left
    },
    stimulusRight: function() {
      return "img/" + stimuli[trial_count].right
    },
    choices: ['leftArrow', 'rightArrow'],
    trial_duration: stim_dur,
    data: {
      trial_phase: "choice",
      stimulusLeft: function() {
        return stimuli[trial_count].left
      },
      stimulusRight: function() {
        return stimuli[trial_count].right
      }
    },
    on_finish: function(data) {
      if (data.key_press == 39) {
        data.resp = "right"
      } else if (data.key_press == 37) {
        data.resp = "left"
      } else {
        data.resp = null
        consec_miss++
        total_miss++
      }
      if (data.key_press != null) {
        data.choice = stimuli[trial_count][data.resp]
        consec_miss = 0
      } else {
        data.choice = null
      }
      data.cor = data.choice == "fractal" + cor_choice + ".jpg"
      data.cor_im = "fractal" + cor_choice + ".jpg"
    }
  };

  // Highlight chosen !!! How should we fix the styling of this?
  var response_display = {
    type: '2image-keyboard-response',
    stimulusLeft: function() {
      if (jsPsych.data.get().last(1).values()[0].resp != null) {
      return "img/" + stimuli[trial_count].left
    } else {
      return "img/blank.png" // when response is missed, a blank image is displayed with a prompt
      }
    },
    stimulusRight: function() {
      if (jsPsych.data.get().last(1).values()[0].resp != null) {
      return "img/" + stimuli[trial_count].right
      } else {
        return "img/blank.png"
      }
    },
    choices: [jsPsych.NO_KEYS],
    highlight: function() {
      return jsPsych.data.get().last(1).values()[0].resp
    },
    prompt: function() {
      if (jsPsych.data.get().last(1).values()[0].resp == null) {
        return "Too slow! No image selected."
      } else {
        return null
      }
    },
    trial_duration: stim_dur,
    data: {
      trial_phase: "resp_fb"
    }
  };

  // Display outcome
  var outcome_display = {
    type: 'html-keyboard-response',
    prompt: 'Points change',
    stimulus: function() {
      var data = jsPsych.data.get().filter({
        trial_phase: "choice"
      }).last(1).values()[0]
      if (data.cor) {
        var oc = cor_oc[correctCount]
      } else {
        if (data.resp == null) {
          var oc = loss_value_incor
          }
          else {
          var oc = incor_oc[incorrectCount]
        }
      }

      return oc
    },
    choices: [jsPsych.NO_KEYS],
    trial_duration: oc_dur,
    data: {
      trial_phase: "oc_fb"
    }
  };

  // Display total
  var cumulative_display = {
    type: 'html-keyboard-response',
    prompt: 'Cumulative total',
    stimulus: function() {
      var data = jsPsych.data.get().filter({
        trial_phase: "choice"
      }).last(1).values()[0]
      if (data.cor) {
        cumulative = cumulative +cor_oc[correctCount]
        correctCount++
      } else {
        if (data.resp == null) {
          cumulative = cumulative + loss_value_incor
          } else {
          cumulative = cumulative + incor_oc[incorrectCount]
          incorrectCount++
        }
      }
      return cumulative
    },
    choices: [jsPsych.NO_KEYS],
    trial_duration: cum_dur,
    data: {
      trial_phase: "cum_fb"
    },
    on_finish: function(data) {
      trial_count++
      event_trial_count++
      if (reversal_point.includes(trial_count)) {
          cor_choice = (cor_choice * -1) + 3;
        }
    }
  };

  //***** Define task loop *****//

  var prl = [stimuli_display, response_display, outcome_display, cumulative_display]
  var main = {
    timeline: prl,
    loop_function: function() {
      if (trial_count < n_trials && consec_miss <= cm_thresh && total_miss <= Math.ceil(total_thresh*n_trials)) {
        return true
      } else {
        return false
      }
    }
  }

  //***** Set-up the timeline *****//
  var timeline = []
  timeline.push({
    type: 'fullscreen',
    fullscreen_mode: true
  });
  timeline.push(instructions);
  timeline.push(main);
  timeline.push({
    type: 'fullscreen',
    fullscreen_mode: false
  });

  //***** Start the experiment *****//
  jsPsych.init({
    // !!! How can we use these browser interactions in the conditional task loop (line 208) to terminate if people click away?
    // for now this just terminates the experiment and displays an error message
    // the 'blur' event is moving away from the browser window, i.e. clicking another window or tab
    on_interaction_data_update: function(data) {
      console.log(data)
      if(data.trial > 2 & (data.event == "blur" | data.event == "fullscreenexit")){ // probably want to start this after the instruction - a bit harsh if we kick them out while they are reading the instructions if they change screens
        jsPsych.endExperiment("Detected a change of screen focus.<br>"+JSON.stringify(data))
      }
    },
    timeline: timeline,
    on_finish: function() {
      //jsPsych.data.displayData(); // this is suppressed for now because it interferes with the end experiment error message
    }
  });
</script>

</html>
