<!DOCTYPE html>
<html>

<head>
  <title>My experiment</title>
  <script src="jspsych-6.1.0/jspsych.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-2image-keyboard-response.js"></script>
  <script src="extra_js/functions.js"></script>
  <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>

<body></body>
<script>
  var n_trials = 10;
  var prob_cor = 1;
  var prob_incor = 0.1;
  var max_consec = 10;
  var win_value_cor = 1;
  var loss_value_cor = -1;
  var win_value_incor = 1;
  var loss_value_incor = -1;
  var stimuli = [];
  var correctCount = 0;
  var incorrectCount = 0;
  var score = 0;
  var event_trial_count = 0;
  var criterionDenominator = 2;
  var crit = 1;
  var n_trials_at_crit = 0;
  var stim_dur = 200;
  var oc_dur = 200;
  var cum_dur = 200;
  var criterion = false;
  var cumulative = 0


  var cor_choice = jsPsych.randomization.sampleWithoutReplacement([1, 2], 1) // select initial correct stimulus


  for (var i = 0; i < n_trials; i++) {
    stimuli.push(imageShuffle())
  }

  var cor_oc = makeArray(prob_cor, n_trials, max_consec, win_value_cor, loss_value_cor)
  var incor_oc = makeArray(prob_incor, n_trials, max_consec, win_value_incor, loss_value_incor)


  var trial_count = 0;
  /* create timeline */
  var timeline = [];

  /* define welcome message trial */
  var welcome = {
    type: "html-keyboard-response",
    stimulus: "Welcome to the experiment. Press any key to begin."
  };
  timeline.push(welcome);

  //var stimuli = ['img/fractal1.jpg','img/fractal2.jpg']
  //var stimuli_shuffled = jsPsych.randomization.repeat(stimuli, 1)

  /* test trials */
  var stimuli_display = {
    type: '2image-keyboard-response',
    stimulusLeft: function() {
      return "img/" + stimuli[trial_count].left
    },
    stimulusRight: function() {
      return "img/" + stimuli[trial_count].right
    },
    choices: ['leftArrow', 'rightArrow'],
    data: {
      trial_phase: "choice",
      stimulusLeft: function() {
        return stimuli[trial_count].left
      },
      stimulusRight: function() {
        return stimuli[trial_count].right
      }
    },
    on_finish: function(data) {
      if (data.key_press == 39) {
        data.resp = "right"
      } else if (data.key_press == 37) {
        data.resp = "left"
      } else {
        data.resp = NULL
      }

      data.choice = stimuli[trial_count][data.resp]
      data.cor = data.choice == "fractal" + cor_choice + ".jpg"
      data.cor_im = "fractal" + cor_choice + ".jpg"
    }
  };


  var response_display = {
    type: '2image-keyboard-response',
    stimulusLeft: function() {
      return "img/" + stimuli[trial_count].left
    },
    stimulusRight: function() {
      return "img/" + stimuli[trial_count].right
    },
    choices: [jsPsych.NO_KEYS],
    highlight: function() {
      return jsPsych.data.get().last(1).values()[0].resp
    },
    trial_duration: stim_dur,
    data: {
      trial_phase: "resp_fb"
    }
  };


  var outcome_display = {
    type: 'html-keyboard-response',
    prompt: 'Points change',
    stimulus: function() {
      var data = jsPsych.data.get().filter({
        trial_phase: "choice"
      }).last(1).values()[0]
      if (data.cor) {
        var oc = cor_oc[correctCount]
      } else {
        var oc = incor_oc[incorrectCount]
      }

      return oc
    },
    choices: [jsPsych.NO_KEYS],
    trial_duration: oc_dur,
    data: {
      trial_phase: "oc_fb"
    }
  }

  var cumulative_display = {
    type: 'html-keyboard-response',
    prompt: 'Cumulative total',
    stimulus: function() {
      var data = jsPsych.data.get().filter({
        trial_phase: "choice"
      }).last(1).values()[0]
      if (data.cor) {
        cumulative = cumulative +cor_oc[correctCount]
      } else {
        cumulative = cumulative + incor_oc[incorrectCount]
      }

      if (data.cor) {
        correctCount++
      } else {
        incorrectCount++
      }

      return cumulative
    },
    choices: [jsPsych.NO_KEYS],
    trial_duration: cum_dur,
    data: {
      trial_phase: "cum_fb"
    },



    on_finish: function(data) {
      trial_count++
      event_trial_count++
      if (event_trial_count > criterionDenominator) {
        var n_cor = jsPsych.data.get().last(criterionDenominator * 4).filter({
          cor: true
        }).count()
        if (n_cor >= crit) {
          data.at_crit = true
          n_trials_at_crit = n_trials_at_crit + 1
        } else {
          data.at_crit = false
          n_trials_at_crit = 0
        }
      } else {
        data.at_crit = false
        n_trials_at_crit = 0
      }
      data.n_trials_at_crit = n_trials_at_crit
      return data
    }
  };

  var trial_proc = [stimuli_display, response_display, outcome_display, cumulative_display]

  var loop = {
    timeline: trial_proc,
    loop_function: function() {

      if (trial_count == n_trials.length) { // check number of correct responses in last n responses and change cor_choice if criteria for reversal are met
        return false
      } else {
        var reverse = checkReversal(n_trials_at_crit)
        cor_choice = initReversal(n_trials_at_crit, reverse, cor_choice);
        if (reverse) {
          n_trials_at_crit = 0
          criterion = false
          reverse = false
        }
        return true
      }
    }
  }


  /* start the experiment */
  jsPsych.init({
    timeline: [welcome, loop],
    on_finish: function() {
      jsPsych.data.displayData();
    }
  });
</script>

</html>
